/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*jshint unused:false */
/*global tinymce:true */

/**
 * zotop 扩展工具插件
 */
tinymce.PluginManager.add('zotop_tools', function(editor, url) {	
	
	zotop_tools(editor, editor.settings.tools);

	function zotop_tools(editor, tools){
	    
	    $.each(tools, function(index, tool){
	    	
	        editor.addButton(index, {
	            text: tool.text,
	            title: tool.title || tool.text,
	            icon: tool.icon,
	            onclick: function(){

	                var dialog = $.dialog({
	                    id           : 'insert-html',
	                    url          : tool.url,
	                    title        : tool.text,
	                    width        : tool.width || '90%',
	                    height       : tool.height || '80%',
			            padding      : 0,
			            ok           : $.noop,
			            cancel       : $.noop,
			            oniframeload : function() {
			                this.loading(false);
			            },            
	        			opener       :window
	                }, true).loading(true); ;

	                dialog.addEventListener('close', function(){
	                		var data = this.returnValue;
	                        console.log(data);

	                        if ( tool.type == 'html' ){
	                            editor.insertContent(data);
	                            return true;
	                        }
	                      
	                        var html='';

	                        for(var i=0; i<data.length; i++){
	                            var name        = data[i].name;
	                            var url         = data[i].url;
	                            var description = data[i].description;
	                            var ext         = data[i].ext || url.replace(/.+\./,"");

	                            html += '<div class="insert-data insert-data-'+ext+'">';
	                            if ( ext == 'jpg' || ext == 'jpeg' || ext == 'png' || ext == 'gif' || ext == 'bmp'){
	                                html += '<img src="'+url+'" alt="'+(description||name)+'" />';
	                            } else if ( ext =='swf' ){
	                                html += '<embed quality="high" src="'+url+'" type="application/x-shockwave-flash" allowScriptAccess="always" allowFullScreen="true" mode="transparent" width="500" height="400"></embed>';
	                            }else{
	                                html += '<a href="'+url+'" title="'+(description||name)+'" target="_blank">'+name+'</a>';
	                            }
	                            html += '</div>';
	                        }

	                        editor.insertContent(html);
	                        return true;
	                    });
	            }
	        });

	    });
	}	
});
